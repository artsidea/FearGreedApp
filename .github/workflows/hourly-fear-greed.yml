name: Hourly Fear & Greed Index Update

on:
  schedule:
    - cron: '0 * * * *'  # ë§¤ì‹œê°„ ì‹¤í–‰
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

permissions:
  contents: write

jobs:
  update-fear-greed:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18
        
    - name: Fetch Fear & Greed Index from RapidAPI
      env:
        RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
        RAPIDAPI_HOST: ${{ secrets.RAPIDAPI_HOST }}
      run: |
        echo "ðŸ”‘ API í‚¤ í™•ì¸: ${RAPIDAPI_KEY:0:10}..."
        echo "ðŸŒ API í˜¸ìŠ¤íŠ¸: $RAPIDAPI_HOST"
        
        # RapidAPI í˜¸ì¶œ
        response=$(curl -s -w "HTTP_CODE:%{http_code}" -X GET \
          "https://${RAPIDAPI_HOST}/v1/fgi?region=US" \
          -H "X-RapidAPI-Key: ${RAPIDAPI_KEY}" \
          -H "X-RapidAPI-Host: ${RAPIDAPI_HOST}")
        
        # HTTP ìƒíƒœ ì½”ë“œ ë¶„ë¦¬
        http_code=$(echo "$response" | grep -o "HTTP_CODE:[0-9]*" | cut -d: -f2)
        json_response=$(echo "$response" | sed 's/HTTP_CODE:[0-9]*$//')
        
        echo "ðŸ“¡ HTTP Status: $http_code"
        echo "ðŸ“Š API Response: $json_response"
        
        if [ "$http_code" != "200" ]; then
          echo "âŒ API í˜¸ì¶œ ì‹¤íŒ¨: HTTP $http_code"
          exit 1
        fi
        
        # JSON íŒŒì‹±
        score=$(echo "$json_response" | jq -r '.fgi.now.value // 50')
        classification=$(echo "$json_response" | jq -r '.fgi.now.valueText // "Neutral"')
        
        echo "âœ… íŒŒì‹±ëœ ì ìˆ˜: $score"
        echo "âœ… íŒŒì‹±ëœ ë¶„ë¥˜: $classification"
        
        # ì‹œê°„ ì •ë³´
        current_time=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        
        # docs ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p docs
        
        # hourly.json ìƒì„± (docs í´ë”ì—)
        cat > docs/hourly.json << EOF
{
  "score": $score,
  "classification": "$classification",
  "lastUpdated": "$current_time",
  "timestamp": "$timestamp"
}
EOF
        
        echo "ðŸ“„ ìƒì„±ëœ docs/hourly.json:"
        cat docs/hourly.json
        
    - name: Commit and push changes
      run: |
        # Git ì„¤ì •
        git config --global user.name "github-actions[bot]"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
        # docs/hourly.jsonì´ ì¡´ìž¬í•˜ëŠ”ì§€ í™•ì¸
        if [ -f "docs/hourly.json" ]; then
          echo "docs/hourly.json exists, proceeding with commit"
          
          # docs/hourly.jsonë§Œ ì¶”ê°€
          git add docs/hourly.json
          
          # ë³€ê²½ì‚¬í•­ì´ ìžˆëŠ”ì§€ í™•ì¸
          if git diff --staged --quiet; then
            echo "No changes to commit - hourly.json is up to date"
          else
            echo "Changes detected, committing..."
            git commit -m "Update Fear & Greed Index - $(date -u +'%Y-%m-%d %H:%M UTC')"
            
            # Push with retry logic
            for i in {1..3}; do
              echo "Attempting to push (attempt $i/3)..."
              if git push; then
                echo "Push successful!"
                break
              else
                echo "Push failed, attempt $i/3"
                if [ $i -eq 3 ]; then
                  echo "All push attempts failed"
                  exit 1
                fi
                sleep 5
              fi
            done
          fi
        else
          echo "docs/hourly.json not found, skipping commit"
          exit 1
        fi