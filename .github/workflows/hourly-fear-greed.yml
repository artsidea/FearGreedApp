name: Hourly Fear & Greed Index Update

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  update-fear-greed:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Fetch Fear & Greed Index from RapidAPI
      env:
        RAPIDAPI_KEY: ${{ secrets.RAPIDAPI_KEY }}
        RAPIDAPI_HOST: ${{ secrets.RAPIDAPI_HOST }}
      run: |
        echo "ğŸ”‘ API í‚¤ í™•ì¸: ${RAPIDAPI_KEY:0:10}..."
        echo "ğŸŒ API í˜¸ìŠ¤íŠ¸: $RAPIDAPI_HOST"
        
        response=$(curl -s -w "HTTP_CODE:%{http_code}" -X GET \
          "https://${RAPIDAPI_HOST}/v1/fgi?region=US" \
          -H "X-RapidAPI-Key: ${RAPIDAPI_KEY}" \
          -H "X-RapidAPI-Host: ${RAPIDAPI_HOST}")
        
        http_code=$(echo "$response" | grep -o "HTTP_CODE:[0-9]*" | cut -d: -f2)
        json_response=$(echo "$response" | sed 's/HTTP_CODE:[0-9]*$//')
        
        echo "ğŸ“¡ HTTP Status: $http_code"
        echo "ğŸ“Š API Response: $json_response"
        
        if [ "$http_code" != "200" ]; then
          echo "âŒ API í˜¸ì¶œ ì‹¤íŒ¨: HTTP $http_code"
          exit 1
        fi
        
        score=$(echo "$json_response" | jq -r '.fgi.now.value // 50')
        classification=$(echo "$json_response" | jq -r '.fgi.now.valueText // "Neutral"')
        
        echo "âœ… íŒŒì‹±ëœ ì ìˆ˜: $score"
        echo "âœ… íŒŒì‹±ëœ ë¶„ë¥˜: $classification"
        
        current_time=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        
        echo "{" > hourly.json
        echo "  \"score\": $score," >> hourly.json
        echo "  \"classification\": \"$classification\"," >> hourly.json
        echo "  \"lastUpdated\": \"$current_time\"," >> hourly.json
        echo "  \"timestamp\": \"$timestamp\"" >> hourly.json
        echo "}" >> hourly.json
        
        echo "ğŸ“„ ìƒì„±ëœ hourly.json:"
        cat hourly.json
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: .
        publish_branch: gh-pages
        keep_files: false
        force_orphan: true